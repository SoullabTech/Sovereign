# Soullab.life Consciousness Computing Configuration
# Routes consciousness computing API through secure HTTPS

# Rate limiting zones
limit_req_zone $binary_remote_addr zone=consciousness_api:10m rate=60r/m;
limit_req_zone $binary_remote_addr zone=navigator_api:10m rate=30r/m;
limit_req_zone $binary_remote_addr zone=wisdom_api:10m rate=30r/m;

# Upstream definitions
upstream maia_interface {
    server web:3000 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

upstream navigator_api {
    server navigator-api:7777 max_fails=3 fail_timeout=30s;
    keepalive 16;
}

upstream wisdom_engine {
    server wisdom-engine:3009 max_fails=3 fail_timeout=30s;
    keepalive 16;
}

upstream live_processing {
    server live-processing:3013 max_fails=3 fail_timeout=30s;
    keepalive 16;
}

upstream pioneer_manager {
    server pioneer-manager:3012 max_fails=3 fail_timeout=30s;
    keepalive 16;
}

# HTTPS Server - Production Soullab.life
server {
    listen 443 ssl http2;
    server_name soullab.life www.soullab.life;

    # SSL Configuration
    ssl_certificate /etc/nginx/ssl/soullab.life.crt;
    ssl_certificate_key /etc/nginx/ssl/soullab.life.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # Security Headers for Sacred Technology
    add_header X-Consciousness-Computing "Soullab-Live-Production" always;
    add_header X-Sacred-Technology "Navigator-Wisdom-MAIA-Pipeline" always;
    add_header X-Frame-Options DENY always;
    add_header X-Content-Type-Options nosniff always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https:; font-src 'self' data:;" always;

    # Logging for consciousness computing analytics
    access_log /var/log/nginx/consciousness_computing.log combined;
    error_log /var/log/nginx/consciousness_computing_error.log warn;

    # Main MAIA Interface
    location / {
        # Rate limiting for general interface access
        limit_req zone=consciousness_api burst=20 nodelay;

        proxy_pass http://maia_interface;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 86400;

        # Sacred technology headers
        proxy_set_header X-Consciousness-Computing "Soullab-Production";
        proxy_set_header X-Sacred-Interface "True";
    }

    # Navigator API - Real-time consciousness analysis
    location /api/navigator/ {
        # Stricter rate limiting for consciousness analysis
        limit_req zone=navigator_api burst=10 nodelay;

        proxy_pass http://navigator_api/api/navigator/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 30;
        proxy_connect_timeout 10;

        # Consciousness computing headers
        proxy_set_header X-Navigator-API "Production";
        proxy_set_header X-Consciousness-Analysis "Live";
    }

    # Wisdom Engine - Translation middleware
    location /api/wisdom/ {
        # Rate limiting for wisdom translation
        limit_req zone=wisdom_api burst=10 nodelay;

        proxy_pass http://wisdom_engine/api/wisdom/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 45;
        proxy_connect_timeout 10;

        # Wisdom Engine headers
        proxy_set_header X-Wisdom-Engine "Production";
        proxy_set_header X-Translation-Service "Live";
    }

    # Live Processing - Full pipeline orchestration
    location /api/consciousness/ {
        # Conservative rate limiting for full pipeline
        limit_req zone=consciousness_api burst=5 nodelay;

        proxy_pass http://live_processing/api/consciousness/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 60;
        proxy_connect_timeout 15;

        # Full pipeline headers
        proxy_set_header X-Consciousness-Pipeline "Production";
        proxy_set_header X-Live-Processing "Active";
    }

    # Pioneer Circle Beta Testing
    location /api/beta-testing/ {
        # Rate limiting for pioneer applications
        limit_req zone=consciousness_api burst=10 nodelay;

        proxy_pass http://pioneer_manager/api/beta-testing/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 30;
        proxy_connect_timeout 10;

        # Pioneer Circle headers
        proxy_set_header X-Pioneer-Circle "Q1-2025";
        proxy_set_header X-Beta-Testing "Active";
    }

    # Health checks for all services
    location /health {
        proxy_pass http://maia_interface/api/health;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        access_log off;
    }

    location /api/navigator/health {
        proxy_pass http://navigator_api/health;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        access_log off;
    }

    location /api/wisdom/health {
        proxy_pass http://wisdom_engine/health;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        access_log off;
    }

    location /api/consciousness/health {
        proxy_pass http://live_processing/health;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        access_log off;
    }

    location /api/beta-testing/health {
        proxy_pass http://pioneer_manager/health;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        access_log off;
    }

    # Static assets optimization
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header X-Consciousness-Computing "Soullab-Static" always;
        proxy_pass http://maia_interface;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }

    # Security: Block access to sensitive files
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    location ~ \.(env|json|md)$ {
        deny all;
        access_log off;
        log_not_found off;
    }
}

# HTTP Redirect to HTTPS
server {
    listen 80;
    server_name soullab.life www.soullab.life;

    # Redirect all HTTP requests to HTTPS
    return 301 https://$server_name$request_uri;
}

# Local Development Access (HTTP only)
server {
    listen 80;
    server_name localhost 127.0.0.1;

    # Security headers for local development
    add_header X-Consciousness-Computing "Local-Development" always;
    add_header X-Sacred-Technology "Navigator-Wisdom-MAIA-Pipeline" always;

    # Bypass SSL for local Chrome access
    location / {
        proxy_pass http://maia_interface;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 86400;
    }

    # Local API access for testing
    location /api/navigator/ {
        proxy_pass http://navigator_api/api/navigator/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /api/wisdom/ {
        proxy_pass http://wisdom_engine/api/wisdom/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /api/consciousness/ {
        proxy_pass http://live_processing/api/consciousness/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /api/beta-testing/ {
        proxy_pass http://pioneer_manager/api/beta-testing/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}