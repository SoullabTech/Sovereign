#!/bin/bash
#
# MAIA SOVEREIGNTY PRE-COMMIT HOOK
#
# This hook prevents:
# 1. Supabase code from being committed
# 2. Commits to non-approved branches
#
# Enforces the invariant: "We do NOT use Supabase"
#

# ========================================
# 1. Branch Guard Check
# ========================================
BRANCH="$(git branch --show-current)"
ALLOW_DEPLOY="phase4.6-reflective-agentics"

if [[ "$BRANCH" != "$ALLOW_DEPLOY" && "$BRANCH" != feature/* && "$BRANCH" != fix/* && "$BRANCH" != chore/* ]]; then
  echo ""
  echo "üö´ COMMIT BLOCKED: You are on branch '$BRANCH'"
  echo ""
  echo "Allowed branches:"
  echo "   - $ALLOW_DEPLOY (deploy branch)"
  echo "   - feature/* (feature branches)"
  echo "   - fix/* (fix branches)"
  echo "   - chore/* (chore branches)"
  echo ""
  echo "Run 'git reality' to see your current state"
  echo ""
  exit 1
fi

echo "‚úÖ Branch guard: committing to '$BRANCH' (allowed)"

# ========================================
# 2. Supabase Check
# ========================================
echo "üîç Checking for Supabase violations..."

# Check staged files for Supabase imports
VIOLATIONS=$(git diff --cached --name-only | grep -E '\.(ts|tsx|js|jsx)$' | xargs grep -l "@supabase" 2>/dev/null || true)

if [ -n "$VIOLATIONS" ]; then
  echo ""
  echo "‚ùå COMMIT BLOCKED: Supabase violations detected"
  echo ""
  echo "The following files contain @supabase imports:"
  echo "$VIOLATIONS" | sed 's/^/   /'
  echo ""
  echo "MAIA uses local PostgreSQL, not Supabase."
  echo "See CLAUDE.md: 'We do NOT use Supabase'"
  echo ""
  echo "Fix:"
  echo "   1. Use lib/db/postgres.ts for database operations"
  echo "   2. Run: npm run audit:sovereignty"
  echo "   3. Remove Supabase imports and try again"
  echo ""
  exit 1
fi

# Check package.json for Supabase dependencies
if git diff --cached package.json | grep -q "@supabase"; then
  echo ""
  echo "‚ùå COMMIT BLOCKED: Attempting to add Supabase to package.json"
  echo ""
  echo "MAIA uses local PostgreSQL, not Supabase."
  echo "See CLAUDE.md: 'We do NOT use Supabase'"
  echo ""
  exit 1
fi

echo "‚úÖ No Supabase violations detected"
exit 0
