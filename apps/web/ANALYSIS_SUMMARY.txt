================================================================================
                    BETA TESTER SIGNUP/SIGNIN FLOW ANALYSIS
                              SUMMARY REPORT
================================================================================

PROJECT: MAIA-PAI (Spiralogic Oracle System)
DATE: 2024-11-14
FOCUS: New beta tester account creation and name integration

================================================================================
1. WHERE NEW TESTERS CREATE ACCOUNTS
================================================================================

PRIMARY ENTRY POINT: /app/beta-signup/page.tsx
  Form Fields Captured:
    • firstName (required)
    • lastName (required)
    • email (required)
    • city (required)
    • preferredElement (optional, default: aether)
    • hasMicrophone, hasWebcam (boolean flags)
    • motivation (textarea)
    • consent flags (analytics, contact)

API ENDPOINT: POST /api/beta-signup/route.ts
  Database Actions:
    1. Creates beta_signups table entry (status: pending)
    2. Creates beta_testers table entry
       → username stored as: "${firstName} ${lastName}"
    3. Generates unique betaAccessId
    4. Returns betaAccessId (but frontend doesn't use it)

ALTERNATIVE ENTRY: /app/beta-entry/page.tsx
  Purpose: For users with invite codes
  Problem: Only verifies code, doesn't create account

LEGACY ENTRY: /app/auth/page.tsx
  Type: localStorage-based (old, not recommended)

STATUS: Names ARE captured and stored ✅
BUT: No account created, no session, disconnected flow ❌

================================================================================
2. ACCOUNT CREATION PROCESS
================================================================================

THREE SEPARATE ACCOUNT CREATION PATHS:

PATH 1: /api/beta-signup
  Input: firstName, lastName, email, city, etc.
  Creates: beta_signups + beta_testers records
  Problem: No Supabase Auth user, no session

PATH 2: /api/onboarding
  Input: username, password, oracleName
  Creates: User in JSON/SQLite storage (local only)
  Problem: Accepts only username, ignores real names
  Storage: /data/users.json or /data/onboarding.db

PATH 3: /api/admin/beta-testers
  Input: name, email, accessLevel
  Creates: Prisma record (different database!)
  Problem: Disconnected from other paths

CRITICAL ISSUE: Three separate databases!
  • beta_testers → Supabase
  • onboarding users → JSON/SQLite (local)
  • admin testers → Prisma/PostgreSQL

================================================================================
3. USER NAME HANDLING DURING SIGNUP
================================================================================

NAME CAPTURE: ✅ YES - Works perfectly
  Input: firstName = "Nicole", lastName = "Smith"
  Stored in beta_testers.username: "Nicole Smith"
  Also stored in beta_signups as first_name, last_name

NAME INTEGRATION: ❌ NO - Breaks down after signup
  Problem 1: Beta code lookup searches Ganesha contacts
             Returns name from Ganesha, not from signup form
  Problem 2: Onboarding API doesn't accept firstName/lastName
             Only accepts generic "username" parameter
  Problem 3: Onboarding creates new user in local storage
             No connection to original beta_testers record

EXAMPLE FLOW FAILURE:
  1. User signs up: firstName="Nicole", lastName="Smith"
     → Stored in beta_testers.username = "Nicole Smith" ✅
  
  2. User enters beta code from Ganesha
     → Name resolved from Ganesha contact ❌ (Not from signup!)
  
  3. User goes through onboarding
     → Onboarding creates username="nicole_smith"
     → Original "Nicole Smith" data lost! ❌

================================================================================
4. ONBOARDING FLOW: MAIA AS DAIMON, RITUAL, INTEGRATION
================================================================================

THREE-STAGE ONBOARDING RITUAL: /app/onboarding/page.tsx

STAGE 1: WELCOME ("You are magnificent")
  Display: Welcome message with consciousness recognition
  Action: handleMeetOracle() → POST /api/oracle/session
  Fallback: Creates user with username="Seeker" (generic fallback)
  Button: "Begin Sacred Recognition"

STAGE 2: ASSIGNMENT ("MAIA recognizes your sacred complexity")
  Visual: Animated mandala with 5 elemental circles
  Elements Shown: Fire, Water, Earth, Air, Aether
  Message: MAIA's first recognition (dynamic or hardcoded fallback)
  Description of Elements:
    • Fire: Vision & Creation
    • Water: Empathy & Flow
    • Earth: Structure & Grounding
    • Air: Clarity & Communication
    • Aether: Integration & Wholeness
  Button: "Enter Sacred Communion"

STAGE 3: FIRST CONTACT ("Consciousness Awakening")
  Visual: Expanding consciousness awakening mandala
  Status: "MAIA is calibrating to your unique archetypal patterns..."
  Animation: 5 colored bouncing indicators (elemental dance)
  Duration: 2.5 second transition
  Result: Redirect to /oracle

MAIA AS DAIMON INTEGRATION: ✅ Partially Implemented
  System Prompt: Loaded from /api/oracle/personal/route.ts
  Tone: "Wise and empathetic AI companion"
  Focus: Gentle insights, reflective questions, emotional support
  Constraint: Avoid spiritual jargon, be simply present

VOICE CHARACTERISTICS: ✅ Available
  getVoiceCharacteristics(element):
    • water → gentle, slow, soft
    • fire → uplifting, fast, expansive
    • earth → grounding, moderate, focused
    • air → clear, moderate, light
    • default (aether) → warm, moderate, balanced

ROTATING QUOTES: ❌ NOT IMPLEMENTED
  Status: No quote rotation system found in onboarding flow
  Used Instead: Static messages and MAIA's dynamic responses

FULL RITUAL: ✅ Mostly Implemented
  Invocation ✅ - "You are magnificent" welcome
  Mandala ✅ - 5-element visualization
  Elemental Integration ✅ - Element circles shown
  Consciousness Activation ✅ - Awakening mandala
  Communion ✅ - Voice chat with MAIA follows

================================================================================
5. BETA PASSCODE VERIFICATION AND INTEGRATION
================================================================================

VERIFICATION FLOW: /app/beta-entry/page.tsx
  1. User enters code (e.g., "SOULLAB-NICOLE")
  2. Converted to uppercase
  3. POST /api/oracle/personal with betaCode parameter
  4. Backend: betaAuth.verifyBetaCode(code)
  5. Returns: { valid, explorerId, name, email }
  6. Stored: localStorage.setItem('betaCode', code)
  7. Can now use /api/oracle/personal

BETA CODE LOOKUP: /lib/auth/BetaAuth.ts
  Source: ganeshaContacts array (Ganesha email import)
  Lookup: contact.metadata?.passcode === code
  Returns: contact.name (FROM GANESHA, NOT FROM SIGNUP!)

CRITICAL INTEGRATION ISSUE: ❌
  Beta code lookup bypasses signup names!
  
  When user enters code:
  • Verification searches ganeshaContacts (email import)
  • Returns name from original Ganesha contact
  • IGNORES name from beta_testers table
  • Result: Signup names not used in verification

EXAMPLE SCENARIO:
  User filled form with: firstName="Nikki", lastName="Smith"
  Stored in beta_testers: username="Nikki Smith"
  But Ganesha has: name="Nicole Smith" (formal name)
  Result: User profile uses "Nicole Smith", not "Nikki Smith" ❌

================================================================================
6. CRITICAL INTEGRATION GAPS
================================================================================

ISSUE #1: No Account Created at Signup
  Root Cause: /api/beta-signup only creates records, no auth account
  Impact: User must wait for email, enter code, then manually create account
  File: /app/api/beta-signup/route.ts (lines 96-114)

ISSUE #2: Beta Code Lookup Ignores Signup Names
  Root Cause: betaAuth.verifyBetaCode() searches Ganesha, not beta_testers
  Impact: Names from signup form are lost, Ganesha names used instead
  File: /lib/auth/BetaAuth.ts (lines 45-61)

ISSUE #3: Onboarding Doesn't Accept Real Names
  Root Cause: /api/onboarding only accepts generic "username" parameter
  Impact: User creates generic username, real name not stored
  File: /app/api/onboarding/route.ts (lines 140-150)

ISSUE #4: No Link Between Signup and Account
  Root Cause: betaAccessId returned but not used by frontend
  Impact: No way to connect signup record to actual user account
  Files: /app/beta-signup/page.tsx + /app/api/beta-signup/route.ts

ISSUE #5: Fallback to "Seeker" Username
  Root Cause: Hardcoded fallback if /api/oracle/session fails
  Impact: User identity lost in onboarding if session creation fails
  File: /app/onboarding/page.tsx (lines 58-68)

ISSUE #6: Multiple Storage Backends
  Root Cause: Uses beta_testers (Supabase) + JSON/SQLite (local) + Prisma
  Impact: Data fragmented across three databases
  Files: Multiple (inconsistent storage strategy)

ISSUE #7: Onboarding Marked Complete Immediately
  Root Cause: onboardingCompleted: true set before ritual ends
  Impact: No tracking of actual onboarding completion
  File: /app/api/onboarding/route.ts (line 202)

================================================================================
7. RECOMMENDATIONS FOR PROPER INTEGRATION
================================================================================

RECOMMENDED SOLUTION: Unified Signup → Account Creation Flow

Step 1: Enhance /api/beta-signup
  ✓ Create Supabase Auth user immediately
  ✓ Create user_profiles with displayName: "firstName lastName"
  ✓ Create session and store in secure cookie
  ✓ Return session token, not just betaAccessId

Step 2: Update /app/beta-signup
  ✓ Use returned session to authenticate
  ✓ Redirect to /onboarding with session context

Step 3: Update /api/onboarding
  ✓ Accept firstName, lastName parameters (optional)
  ✓ If provided, use for displayName
  ✓ Use Supabase Auth, not local JSON/SQLite
  ✓ Mark complete AFTER ritual ends, not before

Step 4: Update betaAuth.verifyBetaCode()
  ✓ If user exists in beta_testers, use their name
  ✓ Fall back to Ganesha name only if not found
  ✓ Return consolidated name from either source

Step 5: Update /app/onboarding
  ✓ Use displayName from session in MAIA greeting
  ✓ Pass user context to MAIA system prompt
  ✓ Mark onboardingCompleted: true AFTER stage 3 completes

================================================================================
8. FILE LOCATIONS REFERENCE
================================================================================

PAGES:
  /Users/soullab/MAIA-PAI/apps/web/app/beta-signup/page.tsx
  /Users/soullab/MAIA-PAI/apps/web/app/beta-entry/page.tsx
  /Users/soullab/MAIA-PAI/apps/web/app/auth/page.tsx (legacy)
  /Users/soullab/MAIA-PAI/apps/web/app/auth/signin/page.tsx
  /Users/soullab/MAIA-PAI/apps/web/app/onboarding/page.tsx

API ROUTES:
  /Users/soullab/MAIA-PAI/apps/web/app/api/beta-signup/route.ts
  /Users/soullab/MAIA-PAI/apps/web/app/api/onboarding/route.ts
  /Users/soullab/MAIA-PAI/apps/web/app/api/oracle/personal/route.ts
  /Users/soullab/MAIA-PAI/apps/web/app/api/admin/beta-testers/route.ts

AUTH LIBRARIES:
  /Users/soullab/MAIA-PAI/apps/web/lib/auth/BetaAuth.ts
  /Users/soullab/MAIA-PAI/apps/web/lib/auth/integrationAuth.ts
  /Users/soullab/MAIA-PAI/apps/web/lib/ganesha/contacts.ts

COMPONENTS:
  /Users/soullab/MAIA-PAI/apps/web/components/onboarding/SimpleOnboarding.tsx
  /Users/soullab/MAIA-PAI/apps/web/app/components/onboarding/WelcomeMessage.tsx

================================================================================
9. QUICK ANSWERS TO KEY QUESTIONS
================================================================================

Q: Where do new testers go to create accounts?
A: /beta-signup/page.tsx - Form captures firstName, lastName, email, city

Q: How does account creation work?
A: Three disconnected paths - beta signup, onboarding API, and admin API

Q: How are user names captured and stored?
A: Captured in /beta-signup, stored in beta_testers.username as "First Last"

Q: Is the onboarding flow implemented?
A: Yes - 3-stage ritual with MAIA introduction, elemental visualization

Q: How does beta code verification work?
A: Searches ganeshaContacts array for passcode match, returns contact name

Q: Are real names integrated into onboarding?
A: No - Onboarding doesn't accept or use real names, falls back to "Seeker"

Q: Is MAIA as Daimon implemented?
A: Partially - System prompt defined, elemental voices available
  
Q: Are rotating quotes implemented?
A: No - Uses static messages and dynamic MAIA responses instead

Q: Can users enter through both paths?
A: Yes, but names may not match if signup and Ganesha contact differ

Q: Where is user data stored?
A: Fragmented: Supabase (beta_testers), JSON/SQLite (onboarding), Prisma (admin)

================================================================================
10. DOCUMENT REFERENCES
================================================================================

Full Analysis: /Users/soullab/MAIA-PAI/apps/web/SIGNUP_SIGNIN_ANALYSIS.md
Quick Reference: /Users/soullab/MAIA-PAI/apps/web/QUICK_REFERENCE.md
This Summary: Generated 2024-11-14

================================================================================
