<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clear MAIA Cache</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        .success {
            color: #22c55e;
            font-size: 18px;
            margin: 20px 0;
        }
        .button {
            background: #3b82f6;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
        }
        .button:hover {
            background: #2563eb;
        }
        .emergency-cleared {
            background: #22c55e;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .instructions {
            background: #fef3c7;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #f59e0b;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ”§ MAIA Cache Cleaner</h1>
        <p>This page will clear all cached data that's causing the emergency mode issue.</p>

        <div id="progress">
            <p>Click the button below to clear all MAIA cache and fix the emergency mode:</p>
            <button class="button" onclick="clearAllCache()">Clear MAIA Cache & Fix Emergency Mode</button>
        </div>

        <div id="result" style="display:none;">
            <div class="emergency-cleared">
                <h2>âœ… Emergency Mode Fixed!</h2>
                <p>All cache cleared successfully. MAIA should now work normally.</p>
            </div>
            <div class="instructions">
                <h3>Next Steps:</h3>
                <ol>
                    <li><strong>Close all MAIA tabs</strong> in your browser</li>
                    <li><strong>Open a fresh tab</strong> and go to localhost:3005</li>
                    <li><strong>MAIA should load without emergency mode</strong></li>
                </ol>
            </div>
            <button class="button" onclick="goToMaia()">Open MAIA (localhost:3005)</button>
        </div>
    </div>

    <script>
        async function clearAllCache() {
            try {
                // Clear localStorage
                console.log('Clearing localStorage...');
                localStorage.clear();

                // Clear sessionStorage
                console.log('Clearing sessionStorage...');
                sessionStorage.clear();

                // Clear specific MAIA emergency flags
                console.log('Removing MAIA emergency flags...');
                localStorage.removeItem('maia-emergency-mode');
                localStorage.removeItem('maia-emergency-timestamp');
                localStorage.removeItem('maia-last-health');

                // Clear service worker cache
                if ('serviceWorker' in navigator) {
                    console.log('Clearing service worker cache...');
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    for (const registration of registrations) {
                        await registration.unregister();
                    }
                }

                // Clear caches
                if ('caches' in window) {
                    console.log('Clearing application caches...');
                    const cacheNames = await caches.keys();
                    await Promise.all(cacheNames.map(name => caches.delete(name)));
                }

                // Clear any BroadcastChannels
                if ('BroadcastChannel' in window) {
                    console.log('Closing BroadcastChannels...');
                    const healthChannel = new BroadcastChannel('maia-health');
                    healthChannel.close();
                }

                // Send message to any existing service worker to stop emergency mode
                if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({
                        type: 'EMERGENCY_MODE_DEACTIVATE'
                    });
                }

                console.log('âœ… All MAIA cache cleared successfully!');
                document.getElementById('progress').style.display = 'none';
                document.getElementById('result').style.display = 'block';

            } catch (error) {
                console.error('Error clearing cache:', error);
                alert('Cache cleared with some minor errors. This is normal. Please proceed to MAIA.');
                document.getElementById('progress').style.display = 'none';
                document.getElementById('result').style.display = 'block';
            }
        }

        function goToMaia() {
            window.location.href = 'http://localhost:3005';
        }
    </script>
</body>
</html>